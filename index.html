<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Animation complex - World stopped</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>

    <script>
      // カメラのY固定（ダミー）
      AFRAME.registerComponent('lock-y', {
        schema: { y: { type: 'number', default: 1.6 } },
        tick: function () {}
      });

      /* 落下コンポーネント（花びら） */
      AFRAME.registerComponent('petal-fall', {
        schema: { floorY: { type: 'number', default: -10 }, topY: { type: 'number', default: 50 } },
        init: function () {
          this.reset();
          this.speed = 0.8 + Math.random() * 1.2;
          this.yokoA = 0.01 + Math.random() * 0.25;
          this.yokoF = 400 + Math.random() * 200;
          this.kaitens = Math.random() * 1.0;
          this.rotAxis = new THREE.Vector3(Math.random(), Math.random(), Math.random()).normalize();
        },
        reset: function () {
          const angle = Math.random() * Math.PI * 2;
          const minR = 50, maxR = 200;
          const t = Math.random();
          const radius = Math.sqrt(minR*minR + t * (maxR*maxR - minR*minR));
          const x = radius * Math.cos(angle);
          const z = radius * Math.sin(angle);
          this.el.setAttribute('position', `${x} ${this.data.topY} ${z}`);
        },
        tick: function (time, delta) {
          const dt = delta / 1000;
          const obj = this.el.object3D;
          obj.position.y -= this.speed * dt;
          obj.position.x += Math.sin(time / this.yokoF) * this.yokoA;
          obj.rotateOnAxis(this.rotAxis, this.kaitens * dt);
          if (obj.position.y < this.data.floorY) this.reset();
        }
      });

      /* 桜リング配置 */
      AFRAME.registerComponent('skr', {
        schema: {
          radii: { type: 'string', default: '50, 200' },
          counts: { type: 'string', default: '8, 60' },
          model: { type: 'string', default: '#test1' },
          yOffset: { type: 'number', default: -10 },
          scales: { type: 'string', default: '20 20 20 | 20 20 20' }
        },
        init: function () {
          const data = this.data;
          const radiiArray = data.radii.split(',').map(r => parseFloat(r.trim()));
          const countsArray = data.counts.split(',').map(c => parseInt(c.trim()));
          const scalesArray = data.scales.split('|').map(s => s.trim());

          radiiArray.forEach((radius, layerIndex) => {
            const count = countsArray[layerIndex] || countsArray[0];
            const scale = scalesArray[layerIndex] || scalesArray[0];
            const angleStep = 360 / count;

            for (let i = 0; i < count; i++) {
              const angle = i * angleStep;
              const rad = THREE.MathUtils.degToRad(angle);
              const x = radius * Math.sin(rad);
              const z = -radius * Math.cos(rad);

              const modelEl = document.createElement('a-entity');
              modelEl.setAttribute('gltf-model', data.model);
              modelEl.setAttribute('scale', scale);
              modelEl.setAttribute('position', `${x} ${data.yOffset} ${z}`);
              modelEl.setAttribute('rotation', `0 ${Math.random() * 360} 0`);
              this.el.appendChild(modelEl);
            }
          });
        }
      });

      /* 花びら生成（#world の子として追加） */
      document.addEventListener('DOMContentLoaded', () => {
        const world = document.querySelector('#world');
        const COUNT = 400;
        const FIXED_SCALE = '0.5 0.5 0.5';

        for (let i = 0; i < COUNT; i++) {
          const ent = document.createElement('a-entity');
          ent.setAttribute('petal-fall', { floorY: -10, topY: 50 });
          ent.setAttribute('scale', FIXED_SCALE);
          ent.setAttribute('gltf-model', '#test2');
          world.appendChild(ent);
        }
      });
    </script>
  </head>

  <body>
    <a-scene>
      <a-assets>
        <a-asset-item id="test1" src="sakuranoki_1ver2.glb"></a-asset-item>
        <a-asset-item id="test2" src="hanabira.glb"></a-asset-item>
        <a-asset-item id="kusa" src="kusa8.glb"></a-asset-item>
        <a-asset-item id="sky" src="sky2.glb"></a-asset-item>
      </a-assets>

      <!-- カメラは固定（world の外） -->
      <a-entity id="cameraRig" position="0 1.6 0" lock-y="y: 3.2">
        <a-entity camera look-controls wasd-controls="acceleration: 70"></a-entity>
      </a-entity>

      <!-- world に地面・空・桜・花びらをまとめる -->
      <!-- world-move を付けていないので世界は動きません -->
      <a-entity id="world">

        <!-- 地面（必要ならアニメーション停止: animation-mixer="timeScale: 0" を追加） -->
        <a-entity
          gltf-model="#kusa"
          position="0 -10 0"
          rotation="0 0 0"
          scale="100 100 100">
        </a-entity>

        <!-- sky（必要なら animation-mixer="timeScale: 0" を追加） -->
        <a-entity
          gltf-model="#sky"
          position="0 0 0"
          rotation="0 90 0"
          scale="10 10 10">
        </a-entity>

        <!-- 桜リング -->
        <a-entity
          skr="
            radii: 50, 200;
            counts: 8, 60;
            scales: 80 80 80 | 80 80 80;
            model: #test1;
            yOffset: -10;">
        </a-entity>

        <!-- 花びらは DOM 生成で world に追加されます -->

      </a-entity>

    </a-scene>
  </body>
</html>
