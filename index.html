<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>VR Cherry Blossoms - Controller World Move</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>

    <script>
      /* --- スティック操作で世界を動かすコンポーネント --- */
      AFRAME.registerComponent('world-mover', {
        init: function () {
          this.input = { moveX: 0, moveZ: 0, rotY: 0 };

          // スティックの入力を監視
          this.el.sceneEl.addEventListener('axismove', (evt) => {
            const axes = evt.detail.axis;
            // 左手：移動
            if (evt.target.getAttribute('oculus-touch-controls').hand === 'left') {
              this.input.moveX = (Math.abs(axes[2] || axes[0]) > 0.1) ? (axes[2] || axes[0]) : 0;
              this.input.moveZ = (Math.abs(axes[3] || axes[1]) > 0.1) ? (axes[3] || axes[1]) : 0;
            }
            // 右手：回転
            if (evt.target.getAttribute('oculus-touch-controls').hand === 'right') {
              this.input.rotY = (Math.abs(axes[2] || axes[0]) > 0.1) ? (axes[2] || axes[0]) : 0;
            }
          });
        },
        tick: function (time, delta) {
          const dt = delta / 1000;
          const MOVE_SPEED = 20 * dt; 
          const ROT_SPEED = 70 * dt;

          if (this.input.moveX !== 0 || this.input.moveZ !== 0) {
            let pos = this.el.getAttribute('position');
            pos.x -= this.input.moveX * MOVE_SPEED;
            pos.z -= this.input.moveZ * MOVE_SPEED;
            this.el.setAttribute('position', pos);
          }
          if (this.input.rotY !== 0) {
            let rot = this.el.getAttribute('rotation');
            rot.y += this.input.rotY * ROT_SPEED;
            this.el.setAttribute('rotation', rot);
          }
        }
      });

      /* --- 花びら落下処理 --- */
      AFRAME.registerComponent('petal-fall', {
        schema: { floorY: { type: 'number', default: -10 }, topY: { type: 'number', default: 50 } },
        init: function () {
          this.reset();
          this.speed = 0.8 + Math.random() * 1.2;
          this.yokoA = 0.01 + Math.random() * 0.25;
          this.yokoF = 400 + Math.random() * 200;
          this.kaitens = Math.random() * 1.0;
          this.rotAxis = new THREE.Vector3(Math.random(), Math.random(), Math.random()).normalize();
        },
        reset: function () {
          const angle = Math.random() * Math.PI * 2;
          const radius = Math.sqrt(Math.random() * 20000); 
          const x = radius * Math.cos(angle);
          const z = radius * Math.sin(angle);
          this.el.setAttribute('position', `${x} ${this.data.topY} ${z}`);
        },
        tick: function (time, delta) {
          const dt = delta / 1000;
          const obj = this.el.object3D;
          obj.position.y -= this.speed * dt;
          obj.position.x += Math.sin(time / this.yokoF) * this.yokoA;
          obj.rotateOnAxis(this.rotAxis, this.kaitens * dt);
          if (obj.position.y < this.data.floorY) this.reset();
        }
      });

      /* --- 桜配置 --- */
      AFRAME.registerComponent('skr', {
        schema: {
          radii: { type: 'string', default: '50, 200' },
          counts: { type: 'string', default: '8, 60' },
          model: { type: 'string', default: '#test1' },
          yOffset: { type: 'number', default: -10 },
          scales: { type: 'string', default: '80 80 80 | 80 80 80' }
        },
        init: function () {
          const data = this.data;
          const radiiArray = data.radii.split(',').map(r => parseFloat(r.trim()));
          const countsArray = data.counts.split(',').map(c => parseInt(c.trim()));
          const scalesArray = data.scales.split('|').map(s => s.trim());
          radiiArray.forEach((radius, layerIndex) => {
            const count = countsArray[layerIndex] || countsArray[0];
            const scale = scalesArray[layerIndex] || scalesArray[0];
            const angleStep = 360 / count;
            for (let i = 0; i < count; i++) {
              const angle = i * angleStep;
              const rad = THREE.MathUtils.degToRad(angle);
              const x = radius * Math.sin(rad);
              const z = -radius * Math.cos(rad);
              const modelEl = document.createElement('a-entity');
              modelEl.setAttribute('gltf-model', data.model);
              modelEl.setAttribute('scale', scale);
              modelEl.setAttribute('position', `${x} ${data.yOffset} ${z}`);
              modelEl.setAttribute('rotation', `0 ${Math.random() * 360} 0`);
              this.el.appendChild(modelEl);
            }
          });
        }
      });

      document.addEventListener('DOMContentLoaded', () => {
        const content = document.querySelector('#world-content');
        for (let i = 0; i < 400; i++) {
          const ent = document.createElement('a-entity');
          ent.setAttribute('petal-fall', "");
          ent.setAttribute('scale', '0.5 0.5 0.5');
          ent.setAttribute('gltf-model', '#test2');
          content.appendChild(ent);
        }
      });
    </script>
  </head>

  <body>
    <a-scene webxr="referenceSpaceType: local-floor" renderer="colorManagement: true; exposure: 1.3">
      <a-assets>
        <a-asset-item id="test1" src="sakuranoki_1ver2.glb"></a-asset-item>
        <a-asset-item id="test2" src="hanabira.glb"></a-asset-item>
        <a-asset-item id="kusa" src="kusa8.glb"></a-asset-item>
        <a-asset-item id="sky" src="sky2.glb"></a-asset-item>
        <a-asset-item id="bluesheet" src="bluesi-to.glb"></a-asset-item>
        <a-asset-item id="bench" src="bench2.glb"></a-asset-item>
        <a-asset-item id="wagasa" src="wagasa_1_01.glb"></a-asset-item>
      </a-assets>

      <a-entity id="cameraRig" position="0 0 0">
        <a-entity camera position="0 1.6 0" look-controls></a-entity>
        <a-entity oculus-touch-controls="hand: left"></a-entity>
        <a-entity oculus-touch-controls="hand: right"></a-entity>
      </a-entity>

      <a-entity id="world" world-mover>
        <a-entity id="world-content">
          <a-entity gltf-model="#kusa" position="0 -10 0" scale="100 100 100"></a-entity>
          <a-entity skr="model: #test1; yOffset: -10;"></a-entity>
          <a-entity gltf-model="#bluesheet" position="100 -9.5 120" rotation="0 40 0" scale="10 10 10"></a-entity>
          <a-entity gltf-model="#bluesheet" position="0 -9.5 80" rotation="0 85 0" scale="10 10 10"></a-entity>
          <a-entity gltf-model="#bluesheet" position="-110 -9.5 -60" rotation="0 167 0" scale="10 10 10"></a-entity>
          <a-entity gltf-model="#bench" position="35 -10 0" rotation="0 90 0" scale="10 10 10"></a-entity>
          <a-entity gltf-model="#bench" position="-35 -10 0" rotation="0 90 0" scale="10 10 10"></a-entity>
          <a-entity gltf-model="#wagasa" position="-30 -10 10" rotation="0 90 -15" scale="30 40 30"></a-entity>
          <a-entity gltf-model="#wagasa" position="30 -10 -10" rotation="0 90 15" scale="30 40 30"></a-entity>
        </a-entity>
      </a-entity>

      <a-entity gltf-model="#sky" position="0 0 0" rotation="0 90 0" scale="10 10 10"></a-entity>

      <a-light type="ambient" color="#FFF" intensity="1.2"></a-light>
      <a-light type="directional" position="1 4 1" intensity="0.8"></a-light>
    </a-scene>
  </body>
</html>