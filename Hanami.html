<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Animation complex - Centered (XZ movement)</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script>
      // カメラのY軸（高さ）を固定
      AFRAME.registerComponent('lock-y', {
        schema: { y: { type: 'number', default: 1.6 } },
        tick: function () {
          const pos = this.el.object3D.position;
        }
      });
 
      // 花弁の落下コンポーネント（“その間”に出現）
      AFRAME.registerComponent('petal-fall', {
        schema: {
          floorY: { type: 'number', default: -17 },
          topY: { type: 'number', default: 40 }
        },
        init: function () {
          this.reset();
 
          // 動きは最初のものに近い控えめ設定
          this.speed   = 0.8 + Math.random() * 1.2;   // 0.8〜1.2
          this.yokoA   = 0.01 + Math.random() * 0.25; // 0.01〜0.03
          this.yokoF   = 400 + Math.random() * 200;   // 400〜600
          this.kaitens = Math.random() * 1.0;         // 0〜0.5
 
          // 回転軸（ランダム）
          this.rotAxis = new THREE.Vector3(
            Math.random(), Math.random(), Math.random()
          ).normalize();
        },
        reset: function () {
          // 半径50〜200の“その間”に面積均等でランダム配置
          const angle = Math.random() * Math.PI * 2;
          const minR = 50, maxR = 200;
          const t = Math.random();
          const radius = Math.sqrt(minR*minR + t * (maxR*maxR - minR*minR));
 
          const x = radius * Math.cos(angle);
          const z = radius * Math.sin(angle);
          const y = this.data.topY;
 
          this.el.setAttribute('position', `${x} ${y} ${z}`);
        },
        tick: function (time, delta) {
          const dt = delta / 1000;
          const obj = this.el.object3D;
 
          // 落下（最初の速度感に近く）
          obj.position.y -= this.speed * dt;
 
          // 横揺れ（控えめ）
          obj.position.x += Math.sin(time / this.yokoF) * this.yokoA;
 
          // ランダム軸回転（控えめ）
          obj.rotateOnAxis(this.rotAxis, this.kaitens * dt);
 
          // 床より下に落ちたら再配置
          if (obj.position.y < this.data.floorY) {
            this.reset();
          }
        }
      });
 
      // 要調整(skr配置)
      AFRAME.registerComponent('skr', {
        schema: {
          radii: { type: 'string', default: '50, 200' },
          counts: { type: 'string', default: '8, 60' },
          model: { type: 'string', default: '#test1' },
          yOffset: { type: 'number', default: -15 },
          scales: { type: 'string', default: '0.8 0.8 0.8 | 1.0 1.0 1.0' }
        },
        init: function () {
          const data = this.data;
          const el = this.el;
 
          const radiiArray = data.radii.split(',').map(r => parseFloat(r.trim()));
          const countsArray = data.counts.split(',').map(c => parseInt(c.trim()));
          const scalesArray = data.scales.split('|').map(s => s.trim());
 
          radiiArray.forEach((radius, layerIndex) => {
            const count = countsArray[layerIndex] || countsArray[0];
            const scale = scalesArray[layerIndex] || scalesArray[0];
            const angleStep = 360 / count;
 
            for (let i = 0; i < count; i++) {
              const angle = i * angleStep;
              const radians = THREE.MathUtils.degToRad(angle);
              const x = radius * Math.sin(radians);
              const z = -radius * Math.cos(radians);
              const randomRotationY = Math.random() * 360;
 
              const modelEl = document.createElement('a-entity');
              modelEl.setAttribute('gltf-model', data.model);
              modelEl.setAttribute('scale', scale);
              modelEl.setAttribute('position', `${x} ${data.yOffset} ${z}`);
              modelEl.setAttribute('rotation', `0 ${randomRotationY} 0`);
              el.appendChild(modelEl);
            }
          });
        }
      });
 
      // 花弁生成（削除していた位置に復活）
      document.addEventListener('DOMContentLoaded', () => {
        const scene = document.querySelector('a-scene');
        const COUNT = 400;
        const FIXED_SCALE = '0.18 0.18 0.18';
        const useModel = !!document.querySelector('#test2');
 
        for (let i = 0; i < COUNT; i++) {
          const ent = document.createElement('a-entity');
 
          // 落下コンポーネント（その間に出現）
          ent.setAttribute('petal-fall', {
            floorY: 0,
            topY: 50
          });
 
          // 大きさを固定（必要ならここで調整）
          ent.setAttribute('scale', FIXED_SCALE);
 
          if (useModel) {
            ent.setAttribute('gltf-model', '#test2');
          } else {
            ent.innerHTML = `<a-cylinder radius="0.12" height="0.02" color="#F8BBD0" segments-radial="12"></a-cylinder>`;
          }
 
          scene.appendChild(ent);
        }
      });
    </script>
  </head>
 
  <body>
    <a-scene>
      <a-assets>
        <a-asset-item id="test1" src="test2_6.glb"></a-asset-item>
        <a-asset-item id="test2" src="桜花びら.glb"></a-asset-item>
      </a-assets>
 
      <!-- カメラ（高さ固定） -->
      <a-entity id="cameraRig" position="0 1.6 0" lock-y="y: 1.6">
        <a-entity camera look-controls="pointerLockEnabled: true" wasd-controls="acceleration: 70"></a-entity>
      </a-entity>
 
      <!-- 多層リング配置（桜吹雪モデル） -->
      <a-entity
        skr="
          radii: 50, 200;
          counts: 8, 60;
          scales: 20.2 20.2 20.2 | 20.2 20.2 20.2;
          model: #test1;
          yOffset: -10;"
      ></a-entity>
 
      <a-sky color="#ECECEC"></a-sky>
    </a-scene>
  </body>
</html>